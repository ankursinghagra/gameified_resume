<!doctype html>
<html>
  <head>
    <style>
        *{margin: 0;padding: 0;}
        body{
        	background: black;
            overflow: hidden;
        }
        canvas {
		    padding: 0;
		    margin: 0;

		    width: 100vw; 
		    max-width: 100%;
		    height: auto;
		    max-height: 100%;

		    user-select: none; 
		}
    </style>
  </head>
  <body>
    <!-- <script src="https://pixijs.download/release/pixi.js"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/8.2.6/pixi.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.2/pixi.min.js"></script>
    <script src="assets/js/viewport.min.js"></script>
    <script type="module">
        const isViewPort = true;
        const version = 7;
        //import { Assets } from 'pixi.js';

        const WORLD_WIDTH = 2400;
        const WORLD_HEIGHT = 1840;

        
        if(version == 7){
            var app = new PIXI.Application({ height: window.innerHeight, width: window.innerWidth, resizeTo: window });
            globalThis.__PIXI_APP__ = app;
            document.body.appendChild(app.view);
        }else{
            var app = new PIXI.Application();
            if(!isViewPort){
                await app.init({ height: window.innerHeight, width: window.innerWidth, resizeTo: window });
            }else{
                await app.init({ height: window.innerHeight, width: window.innerWidth, resizeTo: window });
            }
            globalThis.__PIXI_APP__ = app;
            document.body.appendChild(app.canvas);
        }
        

        if(isViewPort){
            
            var viewport = new PIXI.Viewport({
                screenWidth: window.innerWidth,
                screenHeight: window.innerHeight,
                worldWidth: WORLD_WIDTH,
                worldHeight: WORLD_HEIGHT,
                events: app.renderer.events,
                stopPropagation: true
                //interaction: app.renderer.__plugins.interaction // the interaction module is important for wheel to work properly when renderer.view is placed or scaled
            });
            
        }

        //loading
        let Hills_array = [];
        for (let i = 0; i < 67; i++) {
            Hills_array.push({alias: 'hills_'+i, src: 'assets/backgrounds/Hills/Hills_'+i+'.png'});
        }

        PIXI.Assets.addBundle('resources', [
            {alias: 'Water_Anim_json', src: 'assets/backgrounds/Anim/Water_Anim.json'},
            {alias: 'Water_Anim_img', src: 'assets/backgrounds/Anim/Water_Anim.png'},
        ].concat(Hills_array));

        const resources = await PIXI.Assets.loadBundle('resources', ()=>{
            console.log("assets loaded");
        });
        
        var home_container = new PIXI.Container();
        home_container.label = "Home Container";
        home_container.interactive = true;

        home_container.addChild( await add_Water_bg());
        home_container.addChild( await add_ground());

        if(isViewPort){
            viewport.addChild(home_container);
            app.stage.addChild(viewport)
            viewport.drag()
            //viewport.pinch()
            viewport.wheel()
            //viewport.decelerate(); 
            //viewport.fit(false, window.innerWidth, window.innerHeight)
            //viewport.fit();
            //viewport.moveCenter(WORLD_WIDTH / 2, WORLD_HEIGHT / 2)
            //viewport.clamp({direction: "all"});
            viewport.on("drag-end", function(){
                if(this.getVisibleBounds().x < 0 && this.getVisibleBounds().y < 0){
                    viewport.moveCorner(0,0);
                }else if(this.getVisibleBounds().y <0 && this.getVisibleBounds().x > WORLD_WIDTH-window.innerWidth){
                    viewport.moveCorner(WORLD_WIDTH-window.innerWidth,0);
                }else if(this.getVisibleBounds().x <0 && this.getVisibleBounds().y > WORLD_HEIGHT-window.innerHeight){
                    viewport.moveCorner(0,WORLD_HEIGHT-window.innerHeight);
                }else if(this.getVisibleBounds().y <0){
                    viewport.moveCorner(this.getVisibleBounds().x,0);
                }else if(this.getVisibleBounds().x <0){
                    viewport.moveCorner(0,this.getVisibleBounds().y);
                }else if(this.getVisibleBounds().x > WORLD_WIDTH-window.innerWidth && this.getVisibleBounds().y > WORLD_HEIGHT-window.innerHeight){
                    viewport.moveCorner(WORLD_WIDTH-window.innerWidth,WORLD_HEIGHT-window.innerHeight);
                }else if(this.getVisibleBounds().x > WORLD_WIDTH-window.innerWidth){
                    viewport.moveCorner(WORLD_WIDTH-window.innerWidth,this.getVisibleBounds().y);
                }else if(this.getVisibleBounds().y > WORLD_HEIGHT-window.innerHeight){
                    viewport.moveCorner(this.getVisibleBounds().x,WORLD_HEIGHT-window.innerHeight);
                }
            });
            viewport.on("zoomed", function(e){
              if(this.lastViewport.scaleX < 1 || this.lastViewport.scaleY < 1){
                let self = this;
                this.ensureVisible(0,0);
                setTimeout(() => {
                  self.fit(false, window.innerWidth, window.innerHeight);
                }, 100);
              }
            });
        }else{
            app.stage.addChild(home_container);
            //app.stage.scale.set(0.4,0.4)
        }

        // adds the ocean background
        async function add_Water_bg(){
            var bg_water = new PIXI.Container();
            bg_water.label = "Water";
 
            for (let i = 0; i < 30; i++) {
                for (let j = 0; j < 23; j++) {
                    if( i>6 && i<20 && j>6 && j<18) continue;
                    let anim = new PIXI.AnimatedSprite(resources.Water_Anim_json.animations.Water);
                    anim.position.set(i*80,j*80);
                    anim.animationSpeed = 1/10;   
                    anim.loop = true;
                    anim.play();
                    bg_water.addChild(anim);
                }            
            }

            return bg_water;
        }

        async function add_ground(){
            var bg_land = new PIXI.Container();
            bg_land.label = "Land";

            let land_pattern_arr = [
                ["--","--","--","--","--","--","00","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","01","02","--","--","--"],
                ["--","--","00","01","01","01","26","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","25","02","--","--"],
                ["--","00","26","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","25","02","_"],
                ["00","26","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","25","02"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","12"],
                ["10","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","15","22"],
                ["20","16","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","15","22","--"],
                ["--","20","21","16","11","11","11","11","21","21","21","55","56","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","15","21","22","--","--"],
                ["--","--","--","20","16","11","11","11","11","11","11","65","66","11","11","11","11","11","11","11","11","11","11","11","11","11","11","11","15","21","21","21","21","21","21","21","21","21","22","--","--","--","--"],
                ["--","--","--","--","20","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","21","22","--","--","--","--","--","--","--","--","--","--","--","--","--","--"],
            ];

            let start = {x:300,y:300};
            for (let i = 0; i < land_pattern_arr.length; i++) {
               for (let j = 0; j < land_pattern_arr[i].length; j++) {
                    if(land_pattern_arr[i][j]=="--") continue;
                    bg_land.addChild(addSprite(resources["hills_"+parseInt(land_pattern_arr[i][j])], start.x+j*40,start.y+i*40,0.5,0.5));             
               }
                
            }
            return bg_land;
        }

        function addSprite(resource, x,y,sx,sy){
            let sp = new PIXI.Sprite(resource);
            sp.position.set(x,y);
            sp.scale.set(sx,sy);
            return sp;
        }
      </script>
  </body>
</html>